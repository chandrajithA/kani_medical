{% extends 'base.html' %}
{% load static %}

{% block title %}
<title>Checkout - Kani Medical</title>
{% endblock %}

{% block style %}
    <link rel="stylesheet" href="{% static 'css/checkout_page.css' %}">
{% endblock %}


{% block content %}
<main>
    <h2 class="paymentpageheading">Shipping & Payment</h2>
    <section class="container">
      
      <!-- Address & Payment Info -->
      <div class="address-info">

      <form id="paymentform" method="POST" action="{% if cart_item_id %}
        {% url 'initiate_payment' cart_item_id=cart_item_id %}
        {% else %}
        {% url 'initiate_payment' %}
        {% endif %}">
        {% csrf_token %}
        <div class="form-row">
          <div class="form-group">
            <label for="firstname">First Name</label>
            <input type="text" id="firstname" name="firstname" value="" required>
          </div>
          <div class="form-group">
            <label for="lastname">Last Name</label>
            <input type="text" id="lastname" name="lastname" value="">
          </div>
        </div>

        <div class="form-row">
          
          <div class="form-group">
            <label for="email">Email</label>
            <input type="email" id="email" name="email" value="" required>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="phone">Phone No</label>
            <input type="tel" id="phone" name="phone" value="" required>
          </div>
          <div class="form-group">
            <label for="pincode">Pin Code</label>
            <input type="text" id="pincode" name="pincode" value="" required>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="address">Street Address</label>
            <input type="text" id="address" name="address" value="" required>
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label for="city">City</label>
            <input type="text" id="city" name="city" value="" required>
          </div>
          <div class="form-group">
            <label for="state">State</label>
            <input type="text" id="state" name="state" value="" required>
          </div>
        </div>
        {% if request.user.is_authenticated and request.user.name and request.user.email and request.user.phone and request.user.pincode and request.user.address and request.user.city and request.user.state %}
        <label>
            <input type="checkbox" id="registeraddress" name="registeraddress"> Same as Register address
        </label>
        {% endif %}

        </form>

      </div>


      <!-- Order Summary -->
      <div class="order-summary">
        <h3>Order Summary</h3>
        
        {% if cart_items %}
        {% for item in cart_items %}

        <div class="orderproductholder">
            <img src="{{item.product.product_main_image.url}}" alt="Plant" class="orderproductimage">
            <div class="orderproductdetails">
              <h4>{{item.product.product_name}}</h4>
              <p>Qty: {{item.quantity}}</p>
            </div>
            <p class="orderproductprice">₹{{item.get_total_price|floatformat:2}}</p>
        </div> 
        
          {% endfor %}
          {% endif %}
      

        
        
        <div class="details">
          
          <div class="totals">
            {% if total_amount %}
              <p><span>Subtotal:</span>₹{{bill_amount|floatformat:2}}</p>
              <p><span>Delivery:</span>{% if delivery_charge %}₹{{delivery_charge|floatformat:2}}{% else %}<span class="deliveryfreetext">FREE</span>{% endif %}</p>
              {% if discount_amount %}
              <p><span>Discount:</span><span class="discounttext">-₹{{discount_amount|floatformat:2}}</span></p>
              {% endif %}
              <p><strong>Total:</strong><span class="finalamounttext"><strong>₹{{final_amount|floatformat:2}}</strong></span></p>
            {% endif %}
          </div>
          <button type="submit" form="paymentform" id="pay-btn" class="submit-btn">Pay Now ₹{{final_amount|floatformat:2}}</button>
        </div>
        
      </div>

      
      
 
  <section>

    <div id="loadingOverlay" style="
    display:none;  /* hidden by default */
    position: fixed;
    top:0;
    left:0;
    width:100%;
    height:100%;
    background: rgba(0,0,0,0.5);
    z-index: 9999;
    color: #fff;
    font-size: 24px;
    align-items: center;
    justify-content: center;
    flex-direction: column;
">
    <div id="loadingMessage">Please wait...</div>
    <div class="spinner" style="
        border: 6px solid var(--white);
        border-top: 6px solid var(--light-blue);
        border-radius: 50%;
        width: 60px;
        height: 60px;
        animation: spin 1s linear infinite;
        margin-top: 20px;
    "></div>
</div>
</main>



  {% if autopopup %}

  <!-- Razorpay popup only after POST -->
  <script src="https://checkout.razorpay.com/v1/checkout.js"></script>
  <script>
    
   

        var options = {
            "key": "{{ razorpay_key }}",
            "amount": "{{ final_amount_pay }}",  // in paise
            "currency": "INR",
            "name": "Kani Medical",
            "description": "Order #{{ order.id }}",
            "order_id": "{{ order.razorpay_order_id }}",
            "timeout": 300,
            "handler": function(response) {

                // Show verification overlay
                const overlay = document.getElementById('loadingOverlay');
                const message = document.getElementById('loadingMessage');
                overlay.style.display = 'flex';
                message.textContent = 'Verifying payment, please wait...';

                var form = document.createElement('form');
                form.method = "POST";
                form.action = "{% url 'verify_payment' %}";

                var csrf = document.createElement('input');
                csrf.type = 'hidden';
                csrf.name = 'csrfmiddlewaretoken';
                csrf.value = '{{ csrf_token }}';
                form.appendChild(csrf);

                for (var key in response) {
                    var input = document.createElement('input');
                    input.type = 'hidden';
                    input.name = key;
                    input.value = response[key];
                    form.appendChild(input);
                }

                var orderIdInput = document.createElement('input');
                orderIdInput.type = 'hidden';
                orderIdInput.name = 'order_id';
                orderIdInput.value = '{{ order.id }}';
                form.appendChild(orderIdInput);
                document.body.appendChild(form);
                form.submit();
            },
            "modal": {
                "ondismiss": function(){
                  fetch("{% url 'payment_cancel' order.razorpay_order_id %}", {method: "POST",
                  headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({"cancel": true})
                  })
                    .then(() => {
                      window.location.href = "{% url 'payment_failed_page' order.id %}"
                    })
                    .catch(() => {
                      window.location.href = "{% url 'payment_failed_page' order.id %}";
                    });
                }
            }
        };

        var rzp1 = new Razorpay(options);
        rzp1.open();
  

  </script>


{% endif %}
  {% endblock %}

  {% block script %}
    <script>
    document.addEventListener("DOMContentLoaded", () => {
        const checkbox = document.querySelector("input[name='registeraddress']");

        const userData = {
            firstname: "{{ user_data.firstname|default:'' }}",
            lastname: "{{ user_data.lastname|default:'' }}",
            email: "{{ user_data.email|default:'' }}",
            phone: "{{ user_data.phone|default:'' }}",
            address: "{{ user_data.address|default:'' }}",
            city: "{{ user_data.city|default:'' }}",
            state: "{{ user_data.state|default:'' }}",
            pincode: "{{ user_data.pincode|default:'' }}",
        };

        const autofilledFields = new Set();

        // ✅ Fill only fields that have userData values
        checkbox?.addEventListener("change", () => {
            if (checkbox.checked) {
                for (const key in userData) {
                    const value = userData[key];
                    const input = document.getElementById(key);
                    if (!input) continue;

                    if (value && value.trim() !== "") {
                        input.value = value;
                        autofilledFields.add(key);
                    }
                    // ❌ else → do nothing, leave field empty for user input
                }
            } else {
                // ✅ Clear only fields that were autofilled
                autofilledFields.forEach(key => {
                    const input = document.getElementById(key);
                    if (input) input.value = "";
                });
                autofilledFields.clear();
            }
        });

        // ✅ If user edits a field manually, don't overwrite or clear it later
        for (const key in userData) {
            const input = document.getElementById(key);
            if (!input) continue;

            input.addEventListener("input", () => {
                autofilledFields.delete(key);
            });
        }

        
    });

    document.getElementById('pay-btn').addEventListener('click', function(e){
    const form = document.getElementById('paymentform');
    
    // ✅ Check if form is valid before showing spinner
    if (form.checkValidity()) {
        const overlay = document.getElementById('loadingOverlay');
        const message = document.getElementById('loadingMessage');
        overlay.style.display = 'flex';
        message.textContent = 'Please wait... initiating payment';
    } else {
        // ❌ Prevent spinner and let browser show validation errors
        e.preventDefault();
        form.reportValidity();  // This will trigger built-in error messages
    }
});

</script>
  {% endblock %}
